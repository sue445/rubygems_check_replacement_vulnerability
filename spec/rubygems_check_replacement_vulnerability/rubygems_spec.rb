require "digest/sha1"

describe RubygemsCheckReplacementVulnerability::Rubygems do
  let(:rubygems) { RubygemsCheckReplacementVulnerability::Rubygems.new(gem_name) }
  let(:gem_name) { "rubicure"}

  describe "vulnerable_versions" do
    subject { rubygems.vulnerable_versions }

    it { should eq ["0.0.6", "0.0.7", "0.1.0", "0.1.1", "0.1.2", "0.1.3", "0.1.4", "0.2.0", "0.2.1", "0.2.2", "0.2.2.1"] }
  end

  describe "#owner_gems" do
    subject { RubygemsCheckReplacementVulnerability::Rubygems.owner_gems(user_id) }

    let(:user_id) { "sue445" }

    its(:count) { should be > 0 }
    it { should include "rubicure" }
  end

  describe "#download_gem" do
    subject { rubygems.download_gem(version, dist_dir) }

    include_context "uses temp dir"

    let(:version)  { "0.1.4" }
    let(:dist_dir) { temp_dir }
    let(:gem_path) { "#{dist_dir}/#{gem_name}-#{version}.gem" }

    it { should eq gem_path }

    it "should download gem file" do
      subject

      aggregate_failures do
        # https://rubygems.org/downloads/rubicure-0.1.4.gem
        expect(File.size(gem_path)).to eq 27_136
        expect(file_sha1(gem_path)).to eq "e1b93dd427542b033ca4e3ffb7976a373d4c63db"
      end
    end

    def file_sha1(file)
      Digest::SHA1.hexdigest(File.read(file))
    end
  end
end
